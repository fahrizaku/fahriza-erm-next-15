// app/api/medical-records/history/route.js
import { NextResponse } from "next/server";
import { db } from "@/lib/db";

export async function GET(request) {
  try {
    // Get query parameters
    const { searchParams } = new URL(request.url);
    const limit = parseInt(searchParams.get("limit") || "15");
    const offset = parseInt(searchParams.get("offset") || "0");
    const search = searchParams.get("search") || "";

    // Get current date at start of day for date comparisons
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);

    // Build where clause
    const whereClause = search
      ? {
          OR: [
            { patient: { name: { contains: search, mode: "insensitive" } } },
            {
              patient: {
                no_rm: {
                  equals: isNaN(parseInt(search))
                    ? undefined
                    : parseInt(search),
                },
              },
            },
            { icdCode: { contains: search, mode: "insensitive" } },
            { diagnosis: { contains: search, mode: "insensitive" } },
          ],
        }
      : {};

    // Get medical records with pagination
    const medicalRecords = await db.medicalRecord.findMany({
      where: whereClause,
      include: {
        patient: {
          select: {
            id: true,
            name: true,
            no_rm: true,
            gender: true,
            birthDate: true,
            isBPJS: true,
          },
        },
        screening: {
          select: {
            complaints: true,
          },
        },
      },
      orderBy: {
        visitDate: "desc",
      },
      skip: offset,
      take: limit,
    });

    // Get total count for pagination info
    const totalCount = await db.medicalRecord.count({
      where: whereClause,
    });

    // Organize medical records by date category
    const organizedRecords = {
      today: [],
      yesterday: [],
      older: [],
    };

    medicalRecords.forEach((record) => {
      const recordDate = new Date(record.visitDate);
      recordDate.setHours(0, 0, 0, 0);

      if (recordDate.getTime() === today.getTime()) {
        organizedRecords.today.push(record);
      } else if (recordDate.getTime() === yesterday.getTime()) {
        organizedRecords.yesterday.push(record);
      } else {
        organizedRecords.older.push(record);
      }
    });

    return NextResponse.json({
      success: true,
      data: medicalRecords,
      organized: organizedRecords,
      pagination: {
        total: totalCount,
        offset,
        limit,
        hasMore: offset + medicalRecords.length < totalCount,
      },
    });
  } catch (error) {
    console.error("Error fetching medical records history:", error);
    return NextResponse.json(
      { success: false, message: "Failed to fetch medical records history" },
      { status: 500 }
    );
  }
}


// app/pasien/riwayat-kunjungan/page.jsx
"use client";

import React, { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import {
  FileText,
  Loader2,
  AlertTriangle,
  Calendar,
  Clock,
  ChevronRight,
  User,
  RefreshCw,
  Shield,
  Stethoscope,
} from "lucide-react";
import { toast } from "react-toastify";

// MedicalRecordCard Component
const MedicalRecordCard = ({ record }) => {
  // Format date
  const formatDate = (dateString) => {
    const date = new Date(dateString);
    return new Intl.DateTimeFormat("id-ID", {
      day: "numeric",
      month: "long",
      year: "numeric",
    }).format(date);
  };

  // Format time
  const formatTime = (dateString) => {
    const date = new Date(dateString);
    return date.toLocaleTimeString("id-ID", {
      hour: "2-digit",
      minute: "2-digit",
    });
  };

  // Function to capitalize each word
  const capitalizeEachWord = (str) => {
    if (!str) return "";
    return str
      .split(" ")
      .map((word) => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
      .join(" ");
  };

  // Calculate age from birthdate
  const calculateAge = (birthDate) => {
    if (!birthDate) return "";
    const today = new Date();
    const birth = new Date(birthDate);
    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();

    if (
      monthDiff < 0 ||
      (monthDiff === 0 && today.getDate() < birth.getDate())
    ) {
      age--;
    }

    return `${age} tahun`;
  };

  // Truncate text with ellipsis
  const truncateText = (text, maxLength) => {
    if (!text) return "";
    return text.length > maxLength
      ? text.substring(0, maxLength) + "..."
      : text;
  };

  return (
    <Link href={`/rekam-medis/${record.id}`} className="block">
      <div className="bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow overflow-hidden">
        <div className="flex items-center justify-between p-3 md:p-4 border-b border-gray-100 bg-gray-50">
          <div className="flex items-center space-x-2">
            <FileText className="h-5 w-5 text-blue-600" />
            <div className="flex flex-col md:flex-row md:items-center">
              <span className="font-medium text-gray-800">
                No. RM: {record.patient.no_rm}
              </span>
              {record.patient.isBPJS && (
                <div className="flex items-center gap-1 md:ml-2 px-2 py-0.5 bg-green-100 text-green-700 rounded-full text-xs w-fit">
                  <Shield className="h-3 w-3" />
                  <span>BPJS</span>
                </div>
              )}
            </div>
          </div>
          <div className="flex flex-col items-end text-xs text-gray-500">
            <div className="flex items-center">
              <Calendar className="h-3 w-3 mr-1" />
              <span>{formatDate(record.visitDate)}</span>
            </div>
            <div className="flex items-center mt-1">
              <Clock className="h-3 w-3 mr-1" />
              <span>{formatTime(record.visitDate)}</span>
            </div>
          </div>
        </div>

        <div className="p-3 md:p-4">
          <div className="flex items-center mb-3">
            <User className="h-4 w-4 text-gray-500 mr-2" />
            <h3 className="font-medium text-gray-900">
              {capitalizeEachWord(record.patient.name)}
              <span className="text-sm text-gray-500 ml-2">
                {record.patient.gender}
                {record.patient.birthDate &&
                  `, ${calculateAge(record.patient.birthDate)}`}
              </span>
            </h3>
          </div>

          {record.icdCode && (
            <div className="mb-2 flex items-center">
              <Stethoscope className="h-4 w-4 text-gray-500 mr-2" />
              <div>
                <span className="text-xs font-medium text-gray-500 mr-1">
                  Diagnosis:
                </span>
                <span className="text-sm">
                  {truncateText(record.diagnosis, 60)}
                </span>
                <span className="ml-1 bg-blue-100 text-blue-800 px-1 py-0.5 rounded text-xs font-mono">
                  {record.icdCode}
                </span>
              </div>
            </div>
          )}

          {record.screening?.complaints && (
            <div className="text-sm text-gray-600">
              <span className="text-xs font-medium text-gray-500 mr-1">
                Keluhan:
              </span>
              {truncateText(record.screening.complaints, 80)}
            </div>
          )}
        </div>

        <div className="px-3 py-2 md:px-4 md:py-3 bg-gray-50 border-t border-gray-100 flex justify-end">
          <div className="flex items-center text-blue-600 text-sm font-medium">
            <span>Lihat Detail</span>
            <ChevronRight className="h-4 w-4 ml-1" />
          </div>
        </div>
      </div>
    </Link>
  );
};

// DateSection Component
const DateSection = ({ title, records }) => {
  if (!records || records.length === 0) return null;

  return (
    <div className="mb-6">
      <h2 className="text-lg font-semibold text-gray-800 mb-3 px-1">{title}</h2>
      <div className="grid grid-cols-1 gap-4">
        {records.map((record) => (
          <MedicalRecordCard key={record.id} record={record} />
        ))}
      </div>
    </div>
  );
};

// Main Page Component
export default function MedicalRecordsHistory() {
  const router = useRouter();
  const [loading, setLoading] = useState(true);
  const [loadingMore, setLoadingMore] = useState(false);
  const [error, setError] = useState(null);
  const [searchTerm, setSearchTerm] = useState("");
  const [organizedRecords, setOrganizedRecords] = useState({
    today: [],
    yesterday: [],
    older: {}, // Changed to object to store records by date
  });
  const [pagination, setPagination] = useState({
    offset: 0,
    limit: 15,
    total: 0,
    hasMore: false,
  });

  // Format date for section title
  const formatSectionDate = (dateString) => {
    const date = new Date(dateString);
    return new Intl.DateTimeFormat("id-ID", {
      day: "numeric",
      month: "long",
      year: "numeric",
    }).format(date);
  };

  // Group older records by date
  const groupRecordsByDate = (records) => {
    const grouped = {};

    if (!records || records.length === 0) return grouped;

    records.forEach((record) => {
      const date = new Date(record.visitDate);
      // Remove time part to group by date only
      const dateKey = new Date(
        date.getFullYear(),
        date.getMonth(),
        date.getDate()
      ).toISOString();

      if (!grouped[dateKey]) {
        grouped[dateKey] = [];
      }

      grouped[dateKey].push(record);
    });

    return grouped;
  };

  // Fetch medical records
  const fetchMedicalRecords = async (offset = 0, append = false) => {
    try {
      // Set the appropriate loading state based on whether we're appending or replacing
      if (append) {
        setLoadingMore(true);
      } else {
        setLoading(true);
      }

      const params = new URLSearchParams({
        limit: pagination.limit,
        offset: offset,
        search: searchTerm,
      });

      const response = await fetch(`/api/medical-records/history?${params}`);

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();

      if (result.success) {
        // Group older records by date
        const groupedOlder = groupRecordsByDate(result.organized.older);

        if (append) {
          // Append new records to existing ones
          const newGroupedOlder = groupRecordsByDate(result.organized.older);

          // Merge the new older records with existing ones
          const mergedOlder = { ...organizedRecords.older };

          // Add new records to existing date groups or create new date groups
          Object.keys(newGroupedOlder).forEach((dateKey) => {
            if (mergedOlder[dateKey]) {
              mergedOlder[dateKey] = [
                ...mergedOlder[dateKey],
                ...newGroupedOlder[dateKey],
              ];
            } else {
              mergedOlder[dateKey] = newGroupedOlder[dateKey];
            }
          });

          setOrganizedRecords({
            today: [...organizedRecords.today, ...result.organized.today],
            yesterday: [
              ...organizedRecords.yesterday,
              ...result.organized.yesterday,
            ],
            older: mergedOlder,
          });
        } else {
          // Replace with new records
          setOrganizedRecords({
            today: result.organized.today,
            yesterday: result.organized.yesterday,
            older: groupedOlder,
          });
        }

        setPagination(result.pagination);
      } else {
        setError(result.message || "Failed to fetch medical records");
        toast.error(result.message || "Failed to fetch medical records");
      }
    } catch (error) {
      console.error("Error fetching data:", error);
      setError("An error occurred while fetching data");
      toast.error("An error occurred while fetching data");
    } finally {
      // Reset the appropriate loading state
      if (append) {
        setLoadingMore(false);
      } else {
        setLoading(false);
      }
    }
  };

  // Initial fetch
  useEffect(() => {
    fetchMedicalRecords(0, false);
  }, []);

  // Handle search
  const handleSearch = (e) => {
    e.preventDefault();
    fetchMedicalRecords(0, false);
  };

  // Handle load more
  const handleLoadMore = () => {
    if (pagination.hasMore && !loadingMore) {
      fetchMedicalRecords(pagination.offset + pagination.limit, true);
    }
  };

  // Calculate total records displayed
  const getTotalDisplayed = () => {
    let olderCount = 0;
    Object.values(organizedRecords.older).forEach((records) => {
      olderCount += records.length;
    });

    return (
      organizedRecords.today.length +
      organizedRecords.yesterday.length +
      olderCount
    );
  };

  // Sort dates in descending order (newest first)
  const getSortedDates = () => {
    return Object.keys(organizedRecords.older).sort(
      (a, b) => new Date(b) - new Date(a)
    );
  };

  return (
    <div className="max-w-4xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
      <div className="mb-6">
        <h1 className="text-2xl font-bold text-gray-800 mb-2">
          Riwayat Rekam Medis
        </h1>
        <p className="text-gray-600">Riwayat rekam medis pasien</p>
      </div>

      {/* Loading State */}
      {loading && (
        <div className="flex justify-center items-center py-12">
          <div className="text-center">
            <Loader2 className="h-10 w-10 animate-spin text-blue-500 mx-auto" />
            <p className="mt-4 text-gray-600">Memuat rekam medis...</p>
          </div>
        </div>
      )}

      {/* Error State */}
      {error && !loading && (
        <div className="bg-red-50 border-l-4 border-red-500 p-4 rounded-md">
          <div className="flex items-start">
            <AlertTriangle className="h-6 w-6 text-red-500 mr-3 flex-shrink-0" />
            <div>
              <h3 className="text-lg font-medium text-red-800">Error</h3>
              <p className="mt-1 text-red-700">{error}</p>
              <button
                onClick={() => fetchMedicalRecords(0, false)}
                className="mt-3 px-4 py-2 bg-white text-red-700 border border-red-300 rounded-md hover:bg-red-50 transition-colors flex items-center"
              >
                <RefreshCw className="h-4 w-4 mr-2" />
                <span>Coba Lagi</span>
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Content - Medical Records */}
      {!loading && !error && (
        <div>
          {/* No records found */}
          {getTotalDisplayed() === 0 && (
            <div className="text-center py-12 bg-gray-50 rounded-lg border border-gray-200">
              <FileText className="h-12 w-12 text-gray-400 mx-auto mb-3" />
              <h3 className="text-lg font-medium text-gray-800 mb-2">
                Tidak ada rekam medis
              </h3>
              <p className="text-gray-600">
                {searchTerm
                  ? "Tidak ada hasil yang cocok dengan pencarian Anda."
                  : "Belum ada data rekam medis yang tersedia."}
              </p>
            </div>
          )}

          {/* Records by date sections */}
          <DateSection title="Hari Ini" records={organizedRecords.today} />
          <DateSection title="Kemarin" records={organizedRecords.yesterday} />

          {/* Older records grouped by date */}
          {getSortedDates().map((dateKey) => (
            <DateSection
              key={dateKey}
              title={formatSectionDate(dateKey)}
              records={organizedRecords.older[dateKey]}
            />
          ))}

          {/* Load More Button */}
          {pagination.hasMore && (
            <div className="flex justify-center mt-6 mb-4">
              <button
                onClick={handleLoadMore}
                disabled={loadingMore}
                className="px-5 py-2.5 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:ring-4 focus:ring-blue-300 text-gray-700 font-medium flex items-center disabled:opacity-50"
              >
                {loadingMore ? (
                  <>
                    <Loader2 className="h-4 w-4 animate-spin mr-2" />
                    <span>Memuat...</span>
                  </>
                ) : (
                  <span>Muat Lebih Banyak</span>
                )}
              </button>
            </div>
          )}

          {/* Records count */}
          <div className="text-sm text-gray-500 text-center mt-4">
            Menampilkan {getTotalDisplayed()} dari {pagination.total} rekam
            medis
          </div>
        </div>
      )}
    </div>
  );
}


// Prisma schema
// Generator dan Datasource
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Model Patient
model Patient {
  id              Int       @id @default(autoincrement())
  no_rm           Int       @unique
  name            String
  gender          String?
  birthDate       DateTime?
  address         String?
  isBPJS          Boolean
  no_bpjs         String?   @unique
  nik             String?   @unique
  phoneNumber     String?   
  createdAt       DateTime? @default(now())
  updatedAt       DateTime? @updatedAt

    // Relations
  screenings      Screening[]
  medicalRecords  MedicalRecord[]
}

model DrugStoreProduct {
  id            Int         @id @default(autoincrement()) 
  name          String
  category      String?
  manufacturer  String?
  purchasePrice Decimal?
  price         Decimal
  stock         Int
  expiryDate    String?
  unit          String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([name])
  @@index([category])
  @@index([manufacturer])
  @@index([expiryDate])
}

model DrugPrescription {
  id            Int         @id @default(autoincrement()) 
  name          String
  category      String?
  manufacturer  String?
  purchasePrice Decimal?
  price         Decimal
  stock         Int
  expiryDate    String?
  unit          String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([name])
  @@index([category])
  @@index([manufacturer])
  @@index([expiryDate])
}

// Screening model for initial patient assessment
model Screening {
  id                Int           @id @default(autoincrement())
  patientId         Int
  patient           Patient       @relation(fields: [patientId], references: [id])
  complaints        String        // Patient's complaints
  temperature       Decimal?      // Body temperature
  systolicBP        Int?          // Systolic blood pressure (e.g., 120 in "120/80")
  diastolicBP       Int?          // Diastolic blood pressure (e.g., 80 in "120/80")
  pulse             Int?          // Heart rate
  respiratoryRate   Int?          // Breathing rate
  weight            Decimal?      // Weight in kg
  height            Int?          // Height in cm
  waistCircumference Decimal?     // Lingkar pinggang in cm
  oxygenSaturation  Decimal?      // Saturasi oksigen in percentage
  isBPJSActive      Boolean?      // Status BPJS aktif atau tidak
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  // Screening status
  status            String        @default("waiting") // waiting, in-progress, completed
  queueNumber       Int?
  
  // Relations
  medicalRecord     MedicalRecord?
  
  @@index([patientId])
  @@index([status])
  @@index([createdAt])
}

// Queue model for managing patient queue
model OutpatientQueue {
  id                Int           @id @default(autoincrement())
  screeningId       Int           @unique
  queueNumber       Int
  status            String        @default("waiting") // waiting, called, in-progress, completed
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  @@index([status])
  @@index([createdAt])
}

// Medical Record model for storing complete patient visit data
model MedicalRecord {
  id                Int           @id @default(autoincrement())
  patientId         Int
  patient           Patient       @relation(fields: [patientId], references: [id])
  screeningId       Int           @unique
  screening         Screening     @relation(fields: [screeningId], references: [id])
  
  // Doctor's examination
  diagnosis         String?       // Diagnosis description
  icdCode           String?       // ICD-10 code
  clinicalNotes     String?       // Additional clinical notes
  
  // Visit metadata
  visitType         String        @default("outpatient") // outpatient, inpatient
  visitDate         DateTime      @default(now())
  doctorName        String?
  
  // Relations
  prescriptions     Prescription[]  // Changed from Prescription? to Prescription[]
  pharmacyQueue     PharmacyQueue?
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  @@index([patientId])
  @@index([visitDate])
  @@index([icdCode])
}

// Prescription models
model Prescription {
  id                Int               @id @default(autoincrement())
  medicalRecordId   Int               
  medicalRecord     MedicalRecord     @relation(fields: [medicalRecordId], references: [id])
  items             PrescriptionItem[]
  notes             String?           // Additional notes about the prescription
  prescriptionType  String?           // Type of prescription (e.g., "Main", "Follow-up", "Alternative", "Racikan")
  dosage            String?           // Shared dosage instruction for racikan prescriptions
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@index([medicalRecordId])
}

model PrescriptionItem {
  id                Int               @id @default(autoincrement())
  prescriptionId    Int
  prescription      Prescription      @relation(fields: [prescriptionId], references: [id])
  manualDrugName    String?           // For manual entry when drug not in system
  dosage            String?           // Individual dosage (only used for non-racikan prescriptions)
  quantity          Int
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@index([prescriptionId])
}

model PharmacyQueue {
  id                Int               @id @default(autoincrement())
  medicalRecordId   Int               @unique
  medicalRecord     MedicalRecord     @relation(fields: [medicalRecordId], references: [id])
  queueNumber       Int
  status            String            @default("waiting") // waiting, preparing, ready, dispensed
  pharmacistName    String?           // Name of the pharmacist handling the prescription
  notes             String?           // Any special notes for the pharmacist
  startedAt         DateTime?         // When preparation began
  completedAt       DateTime?         // When preparation was completed
  dispensedAt       DateTime?         // When medication was given to patient
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@index([status])
  @@index([createdAt])
  @@index([queueNumber])
}

// ICD-10 lookup table for diagnosis codes
model IcdCode {
  id                Int           @id @default(autoincrement())
  code              String        @unique
  description       String
  version           String?
  
  @@index([code])
}
